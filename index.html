<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <title>–ì—Ä–∞: –°–∫—ñ–ª—å–∫–∏ –º—ñ—Å—Ü—è –∑–∞–π–º–∞—é—Ç—å —Ç–≤–æ—ó —Ñ–∞–π–ª–∏?</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #0f172a;
      color: #e5e7eb;
      display: flex;
      justify-content: center;
    }
    .app {
      max-width: 1100px;
      width: 100%;
      padding: 24px 16px 40px;
    }
    h1 {
      margin-top: 0;
      text-align: center;
      font-size: 1.8rem;
    }
    .card {
      background: #111827;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.45);
      border: 1px solid #1f2937;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
      margin-bottom: 16px;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 10px 18px;
      font-size: 0.95rem;
      cursor: pointer;
      background: #22c55e;
      color: #052e16;
      font-weight: 600;
      box-shadow: 0 10px 25px rgba(34,197,94,0.35);
      transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.1s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    button.secondary {
      /*background: #1f2937;*/
      background:#0c5bc9;
      color: #e5e7eb;
      box-shadow: 0 8px 20px rgba(15,23,42,0.7);
    }
    button:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 5px 14px rgba(0,0,0,0.5);
    }
    button[disabled] {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
    }
    /*.hint {
      font-size: 0.9rem;
      opacity: 0.8;
      text-align: center;
      margin-bottom: 10px;
    }*/

    .hint {

  
  /* –í—ñ–¥—Å—Ç—É–ø–∏ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ */
  padding: 10px;
  
  /* –í—ñ–¥—Å—Ç—É–ø–∏ –∑–æ–≤–Ω—ñ */
  margin: 0 auto 15px auto;
  
  /* –¢–µ–∫—Å—Ç */
  color: #9ca3af; /* –°–≤—ñ—Ç–ª–æ-—Å—ñ—Ä–∏–π –¥–ª—è –∑–≤–∏—á–∞–π–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç—É */
  line-height: 1.6; /* –ë—ñ–ª—å—à–∏–π —ñ–Ω—Ç–µ—Ä–≤–∞–ª –º—ñ–∂ —Ä—è–¥–∫–∞–º–∏ –¥–ª—è –ª–µ–≥–∫–æ—Å—Ç—ñ —á–∏—Ç–∞–Ω–Ω—è */
  text-align: center;
  max-width: 900px; /* –û–±–º–µ–∂—É—î–º–æ —à–∏—Ä–∏–Ω—É, —â–æ–± —Ä—è–¥–æ–∫ –Ω–µ –±—É–≤ –Ω–∞–¥—Ç–æ –¥–æ–≤–≥–∏–º */
}

/* –°—Ç–∏–ª—å –¥–ª—è –≤–∏–¥—ñ–ª–µ–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç—É <b> */
.hint b {
  color: #e5e7eb; /* –Ø—Å–∫—Ä–∞–≤–æ-–±—ñ–ª–∏–π */
  font-weight: 600;
  display: inline-block; /* –©–æ–± —Ç—Ä–æ—Ö–∏ –≤–∏–¥—ñ–ª–∏—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É */
}


    .progress-wrap {
      margin: 12px 0 4px;
    }
    .progress-bar-bg {
      width: 100%;
      height: 10px;
      border-radius: 999px;
      background: #020617;
      overflow: hidden;
      border: 1px solid #1e293b;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #22c55e, #a3e635);
      transition: width 0.1s linear;
    }
    .progress-text {
      font-size: 0.85rem;
      text-align: right;
      opacity: 0.75;
      margin-top: 4px;
    }
    .layout {
      margin-top: 16px;
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
      gap: 18px;
    }
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }
    .summary {
      background: #020617;
      border-radius: 14px;
      padding: 14px 16px;
      border: 1px solid #1f2937;
      min-height: 260px;
    }
    .summary h2 {
      font-size: 1.05rem;
      margin: 0 0 8px;
    }
    .summary-row {
      display: flex;
      justify-content: space-between;
      font-size: 0.93rem;
      margin: 3px 0;
    }
    .summary-row span.label {
      opacity: 0.8;
    }
    .summary-row span.value {
      font-weight: 600;
    }
    .categories {
      margin-top: 10px;
      font-size: 0.9rem;
    }
    .categories h3 {
      font-size: 0.95rem;
      margin: 4px 0 6px;
    }
    .categories-row {
      display: flex;
      justify-content: space-between;
      margin: 2px 0;
      opacity: 0.9;
    }
    .animal-card {
      background: radial-gradient(circle at top, #22c55e22, #020617);
      border-radius: 14px;
      padding: 14px 16px;
      border: 1px solid #1f2937;
      text-align: center;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .animal-name {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .animal-message {
    /*font-size: 0.9rem;
    opacity: 0.9;
    margin-bottom: 10px;*/
    margin: 20px 0;
    /*font-size: 1.2em;*/
    color: #d93025;
    font-weight: bold;
    border: 2px solid #d93025;
    padding: 10px;
    border-radius: 10px;
    }
    .animal-img {
      width: 120px;
      height: 120px;
      border-radius: 16px;
      object-fit: cover;
      border: 1px solid #1f2937;
      background: #020617;
      margin-bottom: 6px;
    }
    .footer-note {
      margin-top: 16px;
      font-size: 0.8rem;
      opacity: 0.7;
      text-align: center;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #1e293b;
      font-size: 0.75rem;
      margin-bottom: 6px;
    }

    /* === –ö–∞–º–µ—Ä–∞ === */
    .camera-section {
      margin-top: 12px;
      text-align: center;
      width: 100%;
    }
    .camera-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-bottom: 8px;
    }
    .camera-view {
      margin-top: 6px;
      position: relative;
      width: 100%;
      max-width: 320px;
      margin-left: auto;
      margin-right: auto;
    }
    .camera-view video,
    .camera-view canvas {
      width: 100%;
      border-radius: 12px;
      border: 1px solid #1f2937;
      background: #020617;
      display: block;
    }
    .camera-view img#maskPreview {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 240px; /* —Ç–≤–æ—è –ø—Ä–∞–≤–∫–∞ */
      border-radius: 12px;
      pointer-events: none;
      opacity: 0.9;
      z-index: 3;
    }
    a#downloadLink {
      display: inline-block;
      margin-top: 6px;
      font-size: 0.85rem;
      text-decoration: none;
      padding: 6px 12px;
      border-radius: 999px;
      background: #1f2937;
      color: #e5e7eb;
    }

    /* –°–ø—ñ–Ω–Ω–µ—Ä –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è */
.system-loader {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 20px 0;
  padding: 20px;
  background: #1e293b; /* –¢–µ–º–Ω–∏–π —Ñ–æ–Ω */
  border-radius: 12px;
  border: 1px solid #374151;
  color: #fbbf24; /* –ñ–æ–≤—Ç–∏–π –∫–æ–ª—ñ—Ä —É–≤–∞–≥–∏ */
}
.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #ffffff22;
  border-top: 4px solid #fbbf24;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 15px;
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
.loader-hint {
  font-size: 0.9rem;
  opacity: 0.8;
  max-width: 400px;
  line-height: 1.5;
}
  </style>
</head>
<body>
<div class="app">
  <!--<h1>–ì—Ä–∞: —Å–∫—ñ–ª—å–∫–∏ –º—ñ—Å—Ü—è –∑–∞–π–º–∞—é—Ç—å —Ç–≤–æ—ó —Ñ–∞–π–ª–∏?</h1>-->
  <h1>üéí –©–æ –≤ —Ç–≤–æ—î–º—É —Ä—é–∫–∑–∞–∫—É?</h1>

  <div class="card">
    <!--<p class="hint">
      –û–±–µ—Ä–∏ –ø–∞–ø–∫—É –Ω–∞ —Å–≤–æ—î–º—É –∫–æ–º–ø‚Äô—é—Ç–µ—Ä—ñ. –ú–∏ –æ—Ü—ñ–Ω–∏–º–æ –æ–±—Å—è–≥ –¢–≤–æ—ó—Ö —Ñ–∞–π–ª—ñ–≤, —â–æ–± —Ç–∏ –∑—Ä–æ–∑—É–º—ñ–≤: —á–∏ –ª–µ–≥–∫–æ –±—É–¥–µ –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ —Ü—ñ –¥–∞–Ω—ñ, —è–∫—â–æ –∫–æ–º–ø'—é—Ç–µ—Ä —Ä–∞–ø—Ç–æ–≤–æ –≤–∏–π–¥–µ –∑ –ª–∞–¥—É? –ú–∏ –ø–æ—Ä–∞—Ö—É—î–º–æ <b>—Ç—ñ–ª—å–∫–∏ —Ñ–æ—Ç–æ, –≤—ñ–¥–µ–æ, –¥–æ–∫—É–º–µ–Ω—Ç–∏, PDF, DBF —Ç–∞ —ñ–Ω—à—ñ –æ—Ñ—ñ—Å–Ω—ñ —Ñ–∞–π–ª–∏</b> ‚Äî –±–µ–∑ —Å–∏—Å—Ç–µ–º–Ω–∏—Ö.
    </p>-->
    <div class="hint">
      <div style="margin-bottom: 8px;">
    üîç <b>–û—Ü—ñ–Ω–∫–∞ —Ä–∏–∑–∏–∫—ñ–≤:</b> –ú–∏ –ø—Ä–æ—Å–∫–∞–Ω—É—î–º–æ –æ–±—Å—è–≥ –¢–≤–æ—ó—Ö —Ñ–∞–π–ª—ñ–≤, —â–æ–± –¢–∏ –∑—Ä–æ–∑—É–º—ñ–≤: —á–∏ –ª–µ–≥–∫–æ –±—É–¥–µ –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ —Ü—ñ –¥–∞–Ω—ñ, —è–∫—â–æ –∫–æ–º–ø'—é—Ç–µ—Ä —Ä–∞–ø—Ç–æ–≤–æ –≤–∏–π–¥–µ –∑ –ª–∞–¥—É?
      </div>
      <div style="font-size: 0.85em; opacity: 0.9; color: #60a5fa;">
        ‚ÑπÔ∏è –†–∞—Ö—É—î–º–æ —Ç—ñ–ª—å–∫–∏ —Ñ–æ—Ç–æ, –≤—ñ–¥–µ–æ, –¥–æ–∫—É–º–µ–Ω—Ç–∏ (PDF, DOC, XLS) ‚Äî –±–µ–∑ —Å–∏—Å—Ç–µ–º–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤.
      </div>
    </div>

    <div class="controls">
      <!-- <button id="pickFilesBtn">üìÇ –û–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª–∏</button> -->
    <!-- <button id="pickFolderBtn" class="secondary">üíª –û–±—Ä–∞—Ç–∏ –ø–∞–ø–∫—É / –¥–∏—Å–∫ –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É</button>
      <button id="resetBtn" class="secondary">üîÅ –°–∫–∏–Ω—É—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>-->
      <button id="pickFolderBtn" class="secondary">üíª –û–±—Ä–∞—Ç–∏ –ø–∞–ø–∫—É / –¥–∏—Å–∫ –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É</button>
  
      <button id="resetBtn" class="secondary" style="display:none;">üîÅ –ù–æ–≤–∏–π –∞–Ω–∞–ª—ñ–∑</button>
    </div>

    <!-- –ø—Ä–∏—Ö–æ–≤–∞–Ω—ñ input-–∏ -->
    <!-- <input id="fileInput" type="file" multiple style="display:none" /> -->
    <input id="folderInput" type="file" webkitdirectory directory multiple style="display:none" />

    <div id="systemProcessing" class="system-loader" style="display: none;">
  <div class="spinner"></div>
  <div style="font-weight: bold; margin-bottom: 5px;">‚è≥ –û—á—ñ–∫—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ –±—Ä–∞—É–∑–µ—Ä–∞...</div>
  <div class="loader-hint">
    –í–∏ –æ–±—Ä–∞–ª–∏ –ø–∞–ø–∫—É. –ó–∞—Ä–∞–∑ –±—Ä–∞—É–∑–µ—Ä —Å–∫–∞–Ω—É—î —ó—ó —Å—Ç—Ä—É–∫—Ç—É—Ä—É. <br>
    –¶–µ –º–æ–∂–µ –∑–∞–π–Ω—è—Ç–∏ <strong>–¥–æ 1 —Ö–≤–∏–ª–∏–Ω–∏</strong>. <br>
    –ë—É–¥—å –ª–∞—Å–∫–∞, –Ω–µ –∑–∞–∫—Ä–∏–≤–∞–π—Ç–µ —Å—Ç–æ—Ä—ñ–Ω–∫—É, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≤–æ–Ω–∞ "–∑–∞–≤–º–µ—Ä–ª–∞".
  </div>
</div>

    <div class="progress-wrap" id="progressSection" style="display:none;">
      <div class="progress-bar-bg">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <div class="progress-text" id="progressText">–ì–æ—Ç—É—î–º–æ—Å—å –¥–æ –ø—ñ–¥—Ä–∞—Ö—É–Ω–∫—É‚Ä¶</div>
    </div>

    <div class="layout" id="resultsSection" style="display:none;">
      <!-- –õ—ñ–≤–∞ —á–∞—Å—Ç–∏–Ω–∞: –ø—ñ–¥—Å—É–º–æ–∫ -->
      <div class="summary" id="summaryBlock">
        <div class="badge">–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª—ñ–∑—É</div>
        <h2>–ü—ñ–¥—Å—É–º–æ–∫ —Ñ–∞–π–ª—ñ–≤</h2>

        <div class="summary-row">
          <span class="label">–ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ñ–∞–π–ª—ñ–≤:</span>
          <span class="value" id="fileCount">0</span>
        </div>
        <div class="summary-row">
          <span class="label">–ó–∞–≥–∞–ª—å–Ω–∏–π —Ä–æ–∑–º—ñ—Ä:</span>
          <span class="value" id="totalSize">0 –ú–ë</span>
        </div>
        <div class="summary-row">
          <span class="label">–û—Ä—ñ—î–Ω—Ç–æ–≤–Ω–∏–π —Ä–æ–∑–º—ñ—Ä —É –ì–ë:</span>
          <span class="value" id="totalSizeGB">0 –ì–ë</span>
        </div>

        <div class="categories">
          <h3>–ó–∞ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è–º–∏</h3>
          <div id="categoriesList"></div>
        </div>
      </div>

      <!-- –ü—Ä–∞–≤–∞ —á–∞—Å—Ç–∏–Ω–∞: —Ç–≤–∞—Ä–∏–Ω–∫–∞ + –∫–∞–º–µ—Ä–∞ -->
      <div class="animal-card" id="animalBlock">
        <div class="badge">–Ü–≥—Ä–æ–≤–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è</div>
        <div class="animal-name" id="animalName">–ü–æ–∫–∏ —â–æ —Ç–∏—Ö–æ‚Ä¶</div>
        <img id="animalImage" class="animal-img" alt="–¢–≤–∞—Ä–∏–Ω–∫–∞" />
        <div class="animal-message" id="animalMessage">
          –û–±–µ—Ä–∏ –ø–∞–ø–∫—É –∞–±–æ —Ñ–∞–π–ª–∏, —â–æ–± –¥—ñ–∑–Ω–∞—Ç–∏—Å—è, —Ö—Ç–æ —Å—å–æ–≥–æ–¥–Ω—ñ –¥–æ —Ç–µ–±–µ –∑–∞–≤—ñ—Ç–∞—î: –∑–∞–π—á–∏–∫, —î–Ω–æ—Ç —á–∏ –æ–ª–µ–Ω—å üê∞ü¶ùü¶å
        </div>

        <div class="camera-section">
          <div class="badge">–°–µ–ª—Ñ—ñ –∑ —Ç–≤–∞—Ä–∏–Ω–∫–æ—é</div>
          <div class="camera-controls">
            <button id="startCameraBtn" class="secondary">üé• –£–≤—ñ–º–∫–Ω—É—Ç–∏ –∫–∞–º–µ—Ä—É</button>
            <button id="takePhotoBtn" disabled>üì∏ –ó—Ä–æ–±–∏—Ç–∏ —Ñ–æ—Ç–æ</button>
            <button id="stopCameraBtn" class="secondary" disabled>‚èπ –ó—É–ø–∏–Ω–∏—Ç–∏ –∫–∞–º–µ—Ä—É</button>
          </div>
          <div class="camera-view">
            <video id="cameraVideo" autoplay playsinline style="display:none;"></video>
            <canvas id="photoCanvas" width="640" height="480" style="display:none;"></canvas>
            <img id="maskPreview" alt="–ú–∞—Å–∫–∞ —Ç–≤–∞—Ä–∏–Ω–∫–∏" style="display:none;">
          </div>
          <a id="downloadLink" href="#" style="display:none;">‚¨áÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–æ—Ç–æ</a>
        </div>
      </div>
    </div>

    <div class="footer-note">
      üîí –£—Å—ñ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫–∏ —Ç–∞ —Ä–æ–±–æ—Ç–∞ –∑ –∫–∞–º–µ—Ä–æ—é –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è <b>–ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä—ñ</b>. –§–∞–π–ª–∏ –Ω—ñ–∫—É–¥–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞—é—Ç—å—Å—è.
    </div>
  </div>
</div>

<script>
  // ===== –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ç–∏–ø—ñ–≤ —Ñ–∞–π–ª—ñ–≤ =====
  const FILE_TYPES = {
    photo: ['jpg', 'jpeg', 'png', 'gif', 'webp', 'heic', 'raw', 'bmp'],
    video: ['mp4', 'mov', 'avi', 'mkv', 'webm'],
    docs: ['doc', 'docx', 'odt', 'rtf'],
    sheets: ['xls', 'xlsx', 'ods', 'csv', 'dbf'],
    pdf: ['pdf'],
    slides: ['ppt', 'pptx', 'odp'],
    text: ['txt', 'md']
  };

  const USER_EXT_SET = new Set(
    Object.values(FILE_TYPES).flat().map(ext => ext.toLowerCase())
  );

  const SYSTEM_PATH_PATTERNS = [
    'windows\\', 'program files', 'programdata', 'system32',
    '/usr/', '/bin/', '/sbin/', '/etc/', '/var/', '/opt/',
    '/library/', '/system/', 'application support'
  ];

  // –ú–∞—Å–∫–∏ –¥–ª—è –∫–æ–∂–Ω–æ—ó —Ç–≤–∞—Ä–∏–Ω–∫–∏
  const FRAME_FILES = {
    deer: 'deer_frame.png',
    bunny: 'bunny_frame.png',
    raccoon: 'raccoon_frame.png'
  };

  // ===== DOM-–µ–ª–µ–º–µ–Ω—Ç–∏ =====
//   const pickFilesBtn   = document.getElementById('pickFilesBtn');
  const pickFolderBtn  = document.getElementById('pickFolderBtn');
  const resetBtn       = document.getElementById('resetBtn');
//   const fileInput      = document.getElementById('fileInput');
  const folderInput    = document.getElementById('folderInput');

  const progressSection = document.getElementById('progressSection');
  const progressBar     = document.getElementById('progressBar');
  const progressText    = document.getElementById('progressText');

  const resultsSection  = document.getElementById('resultsSection');
  const fileCountEl     = document.getElementById('fileCount');
  const totalSizeEl     = document.getElementById('totalSize');
  const totalSizeGBEl   = document.getElementById('totalSizeGB');
  const categoriesList  = document.getElementById('categoriesList');

  const animalNameEl    = document.getElementById('animalName');
  const animalMsgEl     = document.getElementById('animalMessage');
  const animalImgEl     = document.getElementById('animalImage');

  const startCameraBtn  = document.getElementById('startCameraBtn');
  const stopCameraBtn   = document.getElementById('stopCameraBtn');
  const takePhotoBtn    = document.getElementById('takePhotoBtn');
  const videoEl         = document.getElementById('cameraVideo');
  const canvasEl        = document.getElementById('photoCanvas');
  const downloadLinkEl  = document.getElementById('downloadLink');
  const maskPreviewEl   = document.getElementById('maskPreview');

  const systemProcessingEl = document.getElementById('systemProcessing');
  let cameraStream = null;
  let currentAnimalType = null; // 'deer' | 'bunny' | 'raccoon'


  // ===== –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó =====
  function formatBytes(bytes) {
    if (bytes === 0) return '0 –ë';
    const k = 1024;
    const sizes = ['–ë', '–ö–ë', '–ú–ë', '–ì–ë', '–¢–ë'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    const value = (bytes / Math.pow(k, i)).toFixed(2);
    return `${value} ${sizes[i]}`;
  }

  function isSystemPath(path) {
    if (!path) return false;
    const lower = path.toLowerCase();
    return SYSTEM_PATH_PATTERNS.some(pattern => lower.includes(pattern));
  }

  function getExt(fileName) {
    const idx = fileName.lastIndexOf('.');
    if (idx === -1) return '';
    return fileName.slice(idx + 1).toLowerCase();
  }

  function classifyFile(file) {
    const ext = getExt(file.name);
    if (!USER_EXT_SET.has(ext)) return null;
    for (const [category, exts] of Object.entries(FILE_TYPES)) {
      if (exts.includes(ext)) return category;
    }
    return 'other';
  }

  function translateCategory(category) {
    const map = {
      photo: '–§–æ—Ç–æ',
      video: '–í—ñ–¥–µ–æ',
      docs: '–î–æ–∫—É–º–µ–Ω—Ç–∏',
      sheets: '–¢–∞–±–ª–∏—Ü—ñ / DBF',
      pdf: 'PDF',
      slides: '–ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü—ñ—ó',
      text: '–¢–µ–∫—Å—Ç–æ–≤—ñ —Ñ–∞–π–ª–∏',
      other: '–Ü–Ω—à–µ'
    };
    return map[category] || category;
  }

  function resetState() {
    progressSection.style.display = 'none';
    resultsSection.style.display  = 'none';
    progressBar.style.width       = '0%';
    progressText.textContent      = '';

    fileCountEl.textContent   = '0';
    totalSizeEl.textContent   = '0 –ú–ë';
    totalSizeGBEl.textContent = '0 –ì–ë';
    categoriesList.innerHTML  = '';


    animalNameEl.textContent = '–ü–æ–∫–∏ —â–æ —Ç–∏—Ö–æ‚Ä¶';
    animalMsgEl.textContent  =
      '–û–±–µ—Ä–∏ –ø–∞–ø–∫—É –∞–±–æ —Ñ–∞–π–ª–∏, —â–æ–± –¥—ñ–∑–Ω–∞—Ç–∏—Å—è, —Ö—Ç–æ —Å—å–æ–≥–æ–¥–Ω—ñ –¥–æ —Ç–µ–±–µ –∑–∞–≤—ñ—Ç–∞—î: –∑–∞–π—á–∏–∫, —î–Ω–æ—Ç —á–∏ –æ–ª–µ–Ω—å üê∞ü¶ùü¶å';
    animalImgEl.src = '';
    animalImgEl.alt = '–¢–≤–∞—Ä–∏–Ω–∫–∞';
    currentAnimalType = null;

    stopCamera();
    canvasEl.style.display = 'none';
    downloadLinkEl.style.display = 'none';
  }

  // ===== –û–±—Ä–æ–±–∫–∞ –≤–∏–±–æ—Ä—É —Ñ–∞–π–ª—ñ–≤ =====
//   pickFilesBtn.addEventListener('click', () => fileInput.click());
  //pickFolderBtn.addEventListener('click', () => folderInput.click());

// 1. –°–ª—É—Ö–∞—á –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–û–±—Ä–∞—Ç–∏ –ø–∞–ø–∫—É"
  pickFolderBtn.addEventListener('click', () => {
    // –ö–†–û–ö 1: –ü—Ä–∏–º—É—Å–æ–≤–æ –æ—á–∏—â–∞—î–º–æ –≤—Å–µ –ü–ï–†–ï–î –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è–º –¥—ñ–∞–ª–æ–≥—É
    // resetState(); 
    
    // –ö–†–û–ö 2: –û—á–∏—â–∞—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è input. 
    // –¶–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –≤–∞–∂–ª–∏–≤–æ: —Ü–µ —Ä–æ–∑—Ä–∏–≤–∞—î –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —Å—Ç–∞—Ä–∏–π FileList –≤ –ø–∞–º'—è—Ç—ñ –±—Ä–∞—É–∑–µ—Ä–∞
    folderInput.value = ''; 
    
    // 2. –ó–º—ñ–Ω—é—î–º–æ UI –û–î–†–ê–ó–£ (—â–µ –¥–æ –≤–∏–±–æ—Ä—É —Ñ–∞–π–ª—ñ–≤)
    // –•–æ–≤–∞—î–º–æ –∫–Ω–æ–ø–∫—É –≤–∏–±–æ—Ä—É
    pickFolderBtn.style.display = 'none';
    
    // –ü–æ–∫–∞–∑—É—î–º–æ –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è (–Ω–∞ –≤–∏–ø–∞–¥–æ–∫ —è–∫—â–æ –ø–µ—Ä–µ–¥—É–º–∞–ª–∏)
    resetBtn.style.display = 'inline-flex';
    
    // –ü–û–ö–ê–ó–£–Ñ–ú–û –°–ü–Ü–ù–ù–ï–† –û–ß–Ü–ö–£–í–ê–ù–ù–Ø
    systemProcessingEl.style.display = 'flex';
    
    // 3. –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –¥—ñ–∞–ª–æ–≥ (—á–µ—Ä–µ–∑ –Ω–µ–≤–µ–ª–∏–∫—É –∑–∞—Ç—Ä–∏–º–∫—É, —â–æ–± UI –≤—Å—Ç–∏–≥ –æ–Ω–æ–≤–∏—Ç–∏—Å—å)
    setTimeout(() => {
      folderInput.click();
    }, 50);
  });

  //resetBtn.addEventListener('click', resetState);
  resetBtn.addEventListener('click', () => {
    window.location.reload();
  });

//   fileInput.addEventListener('change', () => handleFiles(fileInput.files));
 // folderInput.addEventListener('change', () => handleFiles(folderInput.files));

// 2. –°–ª—É—Ö–∞—á –∑–º—ñ–Ω–∏ input (–°—Ç–∞—Ä—Ç —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—è)
  folderInput.addEventListener('change', (event) => {
    // –î–æ–¥–∞—Ç–∫–æ–≤–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –±–µ–∑–ø–µ–∫–∏
    if (!event.target.files || event.target.files.length === 0) {
        return; // –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞—Ç–∏—Å–Ω—É–≤ "–°–∫–∞—Å—É–≤–∞—Ç–∏" —É –≤—ñ–∫–Ω—ñ –≤–∏–±–æ—Ä—É
    }
    // –•–û–í–ê–Ñ–ú–û –∫–Ω–æ–ø–∫—É –≤–∏–±–æ—Ä—É, –ü–û–ö–ê–ó–£–Ñ–ú–û –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è
    pickFolderBtn.style.display = 'none';
    resetBtn.style.display = 'inline-flex';
    
    // –ö–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä "—Ä–æ–∑–≤–∏—Å–Ω–µ" —ñ –≤—ñ–¥–¥–∞—Å—Ç—å —Ñ–∞–π–ª–∏:
    // –•–û–í–ê–Ñ–ú–û —Å–∏—Å—Ç–µ–º–Ω–∏–π —Å–ø—ñ–Ω–Ω–µ—Ä
    systemProcessingEl.style.display = 'none';
    // –í–∏–∫–ª–∏–∫–∞—î–º–æ –≤–∞—à—É –æ–ø—Ç–∏–º—ñ–∑–æ–≤–∞–Ω—É —Ñ—É–Ω–∫—Ü—ñ—é (–ö—Ä–æ–∫ 1)
    handleFiles(event.target.files);
  });

  // 4. –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞—Ç–∏—Å–Ω—É–≤ –°–ö–ê–°–£–í–ê–¢–ò (–≤—ñ–∫–Ω–æ –∑–∞–∫—Ä–∏–ª–æ—Å—è)
  folderInput.addEventListener('cancel', () => {
    // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –≤—Å–µ —è–∫ –±—É–ª–æ –Ω–∞ –ø–æ—á–∞—Ç–∫—É
    systemProcessingEl.style.display = 'none';
    pickFolderBtn.style.display = 'inline-flex';
    resetBtn.style.display = 'none';
  });

  function handleFiles(fileList) {
    if (!fileList || fileList.length === 0) return;
    
    // 1. –ù–ï –∫–æ–Ω–≤–µ—Ä—Ç—É—î–º–æ –≤ Array.from, –ø—Ä–∞—Ü—é—î–º–æ –∑ fileList –Ω–∞–ø—Ä—è–º—É
    // const files = Array.from(fileList); <--- –¶–ï –í–ò–î–ê–õ–ò–¢–ò

    progressSection.style.display = 'block';
    resultsSection.style.display  = 'none';
    progressBar.style.width       = '0%';
    progressText.textContent      = '–ü—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ —Ñ–∞–π–ª—ñ–≤‚Ä¶';

    //pickFolderBtn.disabled = true;
    //resetBtn.disabled      = true;

    const stats = {
      totalFiles: 0,
      totalBytes: 0,
      categories: {}
    };

    // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≤–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å length –Ω–∞–ø—Ä—è–º—É –∑ –æ–±'—î–∫—Ç–∞
    const total = fileList.length; 
    let processed = 0;

    for (const key of Object.keys(FILE_TYPES)) {
      stats.categories[key] = { count: 0, bytes: 0 };
    }
    stats.categories.other = { count: 0, bytes: 0 };

    // 2. –ó–º–µ–Ω—à—É—î–º–æ —Ä–æ–∑–º—ñ—Ä –ø–∞–∫–µ—Ç—É, —â–æ–± –¥–∞—Ç–∏ UI "–¥–∏—Ö–∞—Ç–∏" —á–∞—Å—Ç—ñ—à–µ
    const batchSize = 1000; 

    function processBatch(start) {
      const end = Math.min(start + batchSize, total);
      
      for (let i = start; i < end; i++) {
        // 3. –î–æ—Å—Ç—É–ø –∑–∞ —ñ–Ω–¥–µ–∫—Å–æ–º –Ω–∞–ø—Ä—è–º—É –¥–æ fileList
        const file = fileList[i]; 
        
        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –≤—Å—è–∫ –≤–∏–ø–∞–¥–æ–∫, —è–∫—â–æ —Ñ–∞–π–ª –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π
        if (!file) continue;

        const path = file.webkitRelativePath || file.name;

        if (isSystemPath(path)) {
          processed++;
          continue;
        }

        const category = classifyFile(file);
        if (!category) {
          processed++;
          continue;
        }

        stats.totalFiles++;
        stats.totalBytes += file.size;
        if (!stats.categories[category]) {
          stats.categories[category] = { count: 0, bytes: 0 };
        }
        stats.categories[category].count++;
        stats.categories[category].bytes += file.size;

        processed++;
      }

      // –û–Ω–æ–≤–ª—é—î–º–æ UI
      const percent = Math.floor((processed / total) * 100);
      progressBar.style.width  = `${percent}%`;
      // –û–Ω–æ–≤–ª—é—î–º–æ —Ç–µ–∫—Å—Ç —Ä—ñ–¥—à–µ, —â–æ–± –Ω–µ –≥–∞–ª—å–º—É–≤–∞—Ç–∏ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –∫–æ–∂–Ω—ñ 1000 —Ñ–∞–π–ª—ñ–≤)
      if (processed % 1000 === 0 || processed === total) {
          progressText.textContent = `–û–ø—Ä–∞—Ü—å–æ–≤–∞–Ω–æ ${processed} –∑ ${total} —Ñ–∞–π–ª—ñ–≤ (${percent}%)`;
      }

      if (processed < total) {
        // setTimeout(..., 0) –¥–∞—î —Ç—Ä–æ—Ö–∏ –±—ñ–ª—å—à–µ —á–∞—Å—É –ø—Ä–æ—Ü–µ—Å–æ—Ä—É –Ω—ñ–∂ requestAnimationFrame —É –≤–∞–∂–∫–∏—Ö –∑–∞–¥–∞—á–∞—Ö
        setTimeout(() => processBatch(end), 0);
      } else {
        finalizeStats(stats);
        //pickFolderBtn.disabled = false;
        //resetBtn.disabled      = false;
      }
    }

    processBatch(0);
  }



  function finalizeStats(stats) {
    resultsSection.style.display = 'grid';

    fileCountEl.textContent = stats.totalFiles.toLocaleString('uk-UA');
    totalSizeEl.textContent = formatBytes(stats.totalBytes);

    const totalGB = stats.totalBytes / (1024 * 1024 * 1024);
    totalSizeGBEl.textContent = totalGB.toFixed(2) + ' –ì–ë';

    categoriesList.innerHTML = '';
    const entries = Object.entries(stats.categories)
      .filter(([_, v]) => v.count > 0)
      .sort((a, b) => b[1].bytes - a[1].bytes);

    if (entries.length === 0) {
      categoriesList.innerHTML =
        '<div style="opacity:0.7;">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∏—Ö —Ñ–∞–π–ª—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.</div>';
    } else {
      for (const [category, info] of entries) {
        const row = document.createElement('div');
        row.className = 'categories-row';
        row.innerHTML = `
          <span>${translateCategory(category)}</span>
          <span>${info.count.toLocaleString('uk-UA')} —à—Ç ¬∑ ${formatBytes(info.bytes)}</span>
        `;
        categoriesList.appendChild(row);
      }
    }

    updateAnimal(totalGB);
  }

  // ===== –í–∏–±—ñ—Ä —Ç–≤–∞—Ä–∏–Ω–∫–∏ =====
  function updateAnimal(totalGB) {
    const totalMB = totalGB * 1024;

    // –°–∫–∏–¥–∞—î–º–æ —Å—Ç–∏–ª—ñ
    animalMsgEl.style.border = "none";
    animalMsgEl.style.color = "inherit";
    animalMsgEl.style.padding = "10px";

    // 1. –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å–ø—ñ–ª—å–Ω—É —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—é –≤ –∑–º—ñ–Ω–Ω—É, —â–æ–± –Ω–µ –¥—É–±–ª—é–≤–∞—Ç–∏ –∫–æ–¥
    // (–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É: —è –ø—Ä–∏–±—Ä–∞–≤ –∑–∞–π–≤—ñ –ø—Ä–æ–±—ñ–ª–∏ –≤ HTML –¥–ª—è –∞–∫—É—Ä–∞—Ç–Ω–æ—Å—Ç—ñ)
    const backupInstructionsHtml = `
        <div style="margin-top: 15px; padding: 12px; font-size: 0.9rem; text-align: left; color: #9ca3af; background: rgba(255,255,255,0.05); border-radius: 8px; border: 1px solid #374151;">
          <strong>–Ø–∫ –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –∑–∞—Ö–∏—Å—Ç –¥–∞–Ω–∏—Ö:</strong>
          <ul style="margin: 8px 0 0 0; padding-left: 20px; line-height: 1.5;">
            <li style="margin-bottom: 8px;">
              üìÑ <span>–ë–µ–∫–∞–ø—É–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –Ω–∞ Google –î–∏—Å–∫</span>
              (<a href="https://ddwr-prd-436285301276-eu-central-1-itb-dev-web-mypb.s3.eu-central-1.amazonaws.com/static/p.guide/upl_files/instr_file/6461e5007d720.pdf?response-content-type=application%2Fpdf&X-Amz-Content-Sha256=UNSIGNED-PAYLOAD&X-Amz-Security-Token=IQoJb3JpZ2luX2VjEJH%2F%2F%2F%2F%2F%2F%2F%2F%2F%2FwEaDGV1LWNlbnRyYWwtMSJHMEUCIHnmDZcBP9sAkgqvZYx%2BLHj1a1tBBlj260W%2BAXEuUuiQAiEAwk2fKIuhqkyWO5imoJF7iCFH%2FqJ0EeNy0Bt6hfn1P48qxQUIWhABGgw0MzYyODUzMDEyNzYiDLimBeoVPQr1ut5GZSqiBZ3HBngaUpAfecErKDjeFPNLnvbi9iqCJqbJDP4d6tGJyO1G1t9gvt%2F6Kz75vaQAkpo0VJ2JLklMGi9NAWhF9Ur%2BW37iWa5Pj6D6JT4XQnfRvLCwv25RPkoQqrtznId1H9A139XAOmFyTCTqScHvRPMf%2FmZVVtUUUcF2J9OW%2Fq3CZU%2FpwnJMaMh8O9JzmtnXeNEsYlC0zp8iF5nA7InET4WNxlcsxNoTU8vpN%2FDjYMwDWVZQkwY5VTThFgIecd3ovHWVYCLjd%2B2LVrpKVnc0yUNQzhZV4z3RoDhwR44nUQUGz2BnOp55H97ztIwu0pZcEy4LT2tTtaM7oytLtO%2BNOwazzhjAh%2BIqmCRupdGCfu1jDy1eM1FmUhVyUcLtnPr%2F4FwftpCBhjOkxDC318%2FdhiKvVmxr%2B3XaBXljUT8tMhmIvxZ54nRZzodZVRGH4lExzWREbJvDhu421l4zt1g0pM2%2BL%2FF9P7ODM2Gsz8jqmpipVFuL0ldnZE8hYURTGY%2F1Q5MYnGTgPxHHBQpX4vUKJDFT86ApKrTjqnRE%2FWWCZPM2NE8pTNcScbQZazIHxdp9ysRYdoRebX7zkLrA%2BQqCvloZfGrjTBA10NwZ9jEplZeJmZ2xnf1IVOiGUagc5Iyswh%2BjbDJVgrKID1lm5v87Ql0ycOIf4pm5UtUPIbx%2FnIY%2F8gjXhDG1uRZpBAde6l%2FvJvbBGL7NkliCANI5s1ZM3PaMppatNtFrvyWr9BkLZGmf8xcbbHwsoaLsruD7BfIQMzIkvMj9t3LEgt9VLw%2BayD4HVtz5znUSzGZK%2FSydkTP2rd%2BRKVWOFkG3Ebi8Q6GdELmi2wQU2o4gcXFAQ6Wk8mD7LdlH3wsXhwwCdnbfIQuFFETdhxBqvV%2Fm%2FmUZ2qMmtweFMOK3yskGOrEBQ%2BrMBTi%2FVJMlXGp6s6LL4jLtfcJvr89SblGhon8%2FqfRUGOztJAjaXK%2BF0etcP%2BhNLNyEKRqUpIao9gC5pzKvcrjXv2iDezMN9FYK0S8vVKNaktKtB7niXvQ9xH%2F0KCE6OFj7MeMqGO1r%2FZHD%2F9si9%2B68uQ%2BemrbwoFTnqvRyFtMeLtXsZ4cw9qgdwNwL%2BbEzDITCFFKDZceZJgEGmFm2Sv21tBQ%2BtK%2F%2F0Rn2Yf3fYl5v&X-Amz-Algorithm=AWS4-HMAC-SHA256&X-Amz-Credential=ASIAWLFFBMIOCDY2L3WO%2F20251205%2Feu-central-1%2Fs3%2Faws4_request&X-Amz-Date=20251205T091724Z&X-Amz-SignedHeaders=host&X-Amz-Expires=180&X-Amz-Signature=b7cfa15f065fd9cfabe66d35822a2abe66b232fb40bef9711aded5a889fdcf81" target="_blank" style="color: #a3e635; text-decoration: underline;">—ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è</a>)
            </li>
            <li>
              ‚¨áÔ∏è <span>–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è </span><a href="https://chromewebstore.google.com/detail/download-manager/nifkjnemcaijlemjjopklbehlndalbnh" target="_blank" style="color: #60a5fa; text-decoration: underline;">Download Manager</a>
              <span style="opacity: 0.8">
                (<a href="https://my.privatbank.ua/other_instructions/eyJpZCI6IjgzMCIsImlJZCI6IjMyMjY4IiwiYmxJZCI6IjQzNzA4IiwidE5tZSI6InFuYSJ9" target="_blank" style="color: #a3e635; text-decoration: underline;">—ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è</a>)
              </span>
            </li>
          </ul>
        </div>
    `;

    // 2. –õ–æ–≥—ñ–∫–∞ –≤–∏–±–æ—Ä—É —Ç–≤–∞—Ä–∏–Ω–∏
    if (totalGB > 3) {
      // --- –û–õ–ï–ù–¨ ---
      currentAnimalType = 'deer';
      animalNameEl.textContent = '–û–ª–µ–Ω—å-–æ—Ö–æ—Ä–æ–Ω–µ—Ü—å ü¶å';
      animalImgEl.src = 'deer.png';
      
      // –°—Ç–∏–ª—ñ –¥–ª—è –û–ª–µ–Ω—è (—á–µ—Ä–≤–æ–Ω—ñ)
      animalMsgEl.style.border = "2px solid #d93025";
      animalMsgEl.style.color = "#d93025";
      animalMsgEl.style.borderRadius = "10px";

      // –¢–µ–∫—Å—Ç –û–ª–µ–Ω—è + –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è
      animalMsgEl.innerHTML = `
        <div style="margin-bottom: 12px;">
          ‚ö†Ô∏è –£–≤–∞–≥–∞: <b>${totalGB.toFixed(2)} GB</b> —Ç–≤–æ—ó—Ö –æ—Å–æ–±–∏—Å—Ç–∏—Ö –¥–∞–Ω–∏—Ö –∑–Ω–∞—Ö–æ–¥—è—Ç—å—Å—è –ø—ñ–¥ –∑–∞–≥—Ä–æ–∑–æ—é –≤—Ç—Ä–∞—Ç–∏ –ø—Ä–∏ –ø–æ–ª–æ–º—Ü—ñ –¥–∏—Å–∫–∞! 
          –ü–æ–¥—É–º–∞–π, —è–∫—ñ —Ñ–∞–π–ª–∏ –≤–∞—Ä—Ç–æ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –Ω–∞ Google –î–∏—Å–∫.
        </div>
        ${backupInstructionsHtml}
      `;

    } else if (totalMB < 100 && totalMB > 0) {
      // --- –ó–ê–ô–ß–ò–ö ---
      currentAnimalType = 'bunny';
      animalNameEl.textContent = '–û–±–µ—Ä–µ–∂–Ω–∏–π –∑–∞–π—á–∏–∫ üê∞';
      animalImgEl.src = 'bunny.png';

      // –¢–µ–∫—Å—Ç –ó–∞–π—á–∏–∫–∞ + –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è
      animalMsgEl.innerHTML = `
        <div style="margin-bottom: 12px;">
          –£ —Ç–µ–±–µ –≤—Å—å–æ–≥–æ <b>${totalMB.toFixed(1)} –ú–ë</b> —Ñ–∞–π–ª—ñ–≤. –¢–∏ –º–æ–ª–æ–¥–µ—Ü—å, –º–∞–π–∂–µ –Ω—ñ—á–æ–≥–æ –∑–∞–π–≤–æ–≥–æ!
          –ê–ª–µ –≤—Å–µ –æ–¥–Ω–æ –∫–æ—Ä–∏—Å–Ω–æ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ –∫–æ–ø—ñ—ó –≤–∞–∂–ª–∏–≤–∏—Ö —Ñ–∞–π–ª—ñ–≤ –Ω–∞ Google –î–∏—Å–∫.
        </div>
        ${backupInstructionsHtml}
      `;

} else if (totalMB === 0) {
      // --- –ü–û–†–û–ñ–ù–¨–û –∞–±–æ –•–ú–ê–†–ê ---
      currentAnimalType = null; 
      
      // –ó–º—ñ–Ω—é—î–º–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –Ω–∞ —â–æ—Å—å –∑–∞–≥–∞–¥–∫–æ–≤–µ –∞–±–æ –ø–æ–∑–∏—Ç–∏–≤–Ω–µ
      animalNameEl.textContent = '–ù–µ–≤–ª–æ–≤–∏–º–∏–π –ø—Ä–∏–≤–∏–¥ üëª'; 
      
      // –Ø–∫—â–æ –Ω–µ–º–∞—î –∫–∞—Ä—Ç–∏–Ω–∫–∏ –¥–ª—è 0 –±–∞–π—Ç, –∫—Ä–∞—â–µ —ó—ó –ø—Ä–∏—Ö–æ–≤–∞—Ç–∏, —â–æ–± –Ω–µ –±—É–ª–æ "–±–∏—Ç–æ–≥–æ" –∑–Ω–∞—á–∫–∞
      animalImgEl.src = ''; 
      animalImgEl.style.display = 'none'; // –•–æ–≤–∞—î–º–æ —Ä–∞–º–∫—É –∫–∞—Ä—Ç–∏–Ω–∫–∏

      // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ innerHTML –¥–ª—è –∫—Ä–∞—Å–∏–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è
      animalMsgEl.innerHTML = `
        <div style="margin-bottom: 12px;">
          –ú–∏ –Ω—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π—à–ª–∏ (<b>0 –ú–ë</b>). –¢—É—Ç –º–æ–∂–ª–∏–≤—ñ –¥–≤–∞ –≤–∞—Ä—ñ–∞–Ω—Ç–∏:
        </div>

        <div style="text-align: left; background: rgba(34, 197, 94, 0.1); border: 1px solid #22c55e; padding: 12px; border-radius: 8px; margin-bottom: 10px;">
          ‚ú® <b>–í–∞—Ä—ñ–∞–Ω—Ç 1: –¢–∏ ‚Äî –•–º–∞—Ä–Ω–∏–π –ì—É—Ä—É!</b><br>
          –Ø–∫—â–æ –≤—Å—ñ —Ç–≤–æ—ó —Ñ–∞–π–ª–∏ –≤–∂–µ –Ω–∞ Google –î–∏—Å–∫—É, —Ç–æ —Ç–∏ –º–æ–ª–æ–¥–µ—Ü—å! –¢–≤–æ—ó –¥–∞–Ω—ñ –≤ –±–µ–∑–ø–µ—Ü—ñ.
        </div>

        <div style="text-align: left; background: rgba(255, 255, 255, 0.05); border: 1px solid #374151; padding: 12px; border-radius: 8px;">
          üîç <b>–í–∞—Ä—ñ–∞–Ω—Ç 2: –ú–∏ –ø—Ä–æ—Å—Ç–æ —Ä–æ–∑–º–∏–Ω—É–ª–∏—Å—è</b><br>
          –ú–æ–∂–ª–∏–≤–æ, —Ç–∏ –æ–±—Ä–∞–≤ –Ω–µ —Ç—É –ø–∞–ø–∫—É? –°–ø—Ä–æ–±—É–π –¥–æ–¥–∞—Ç–∏ <b>"–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è"</b>, <b>"–î–æ–∫—É–º–µ–Ω—Ç–∏"</b> –∞–±–æ <b>"–†–æ–±–æ—á–∏–π —Å—Ç—ñ–ª"</b>, —â–æ–± –ø–µ—Ä–µ–∫–æ–Ω–∞—Ç–∏—Å—è.
        </div>
      `;

    } else {
      // --- –Ñ–ù–û–¢ ---
      currentAnimalType = 'raccoon';
      animalNameEl.textContent = '–•–∏—Ç—Ä–∏–π —î–Ω–æ—Ç ü¶ù';
      animalImgEl.src = 'raccoon.png';

      // –¢–µ–∫—Å—Ç –Ñ–Ω–æ—Ç–∞ + –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è
      animalMsgEl.innerHTML = `
        <div style="margin-bottom: 12px;">
          ‚ö†Ô∏è –£ —Ç–µ–±–µ –ø—Ä–∏–±–ª–∏–∑–Ω–æ <b>${totalGB.toFixed(2)} –ì–ë</b> –æ—Å–æ–±–∏—Å—Ç–∏—Ö —Ñ–∞–π–ª—ñ–≤. –Ñ–Ω–æ—Ç –∫–∞–∂–µ, —â–æ —Ü–µ —Å–∫–∞—Ä–±! 
          –ê–ª–µ —Ä–æ–±–æ—á—ñ —Ñ–∞–π–ª–∏ –∫—Ä–∞—â–µ –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –Ω–∞ Google –î–∏—Å–∫, —â–æ–± –Ω–µ –∑–∞—Ö–∞—Ä–∞—â—É–≤–∞—Ç–∏ –∫–æ–º–ø‚Äô—é—Ç–µ—Ä.
        </div>
        ${backupInstructionsHtml}
      `;
    }
  }



  // ===== –ö–∞–º–µ—Ä–∞ =====
  async function startCamera() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      alert('–ö–∞–º–µ—Ä–∞ –Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î—Ç—å—Å—è –≤ —Ü—å–æ–º—É –±—Ä–∞—É–∑–µ—Ä—ñ.');
      return;
    }
    try {
      cameraStream = await navigator.mediaDevices.getUserMedia({ video: true });
      videoEl.srcObject = cameraStream;

      videoEl.onloadedmetadata = () => {
        canvasEl.width  = videoEl.videoWidth;
        canvasEl.height = videoEl.videoHeight;
      };

      videoEl.style.display = 'block';
      canvasEl.style.display = 'none';
      downloadLinkEl.style.display = 'none';

      const frameSrc = FRAME_FILES[currentAnimalType];
      if (frameSrc) {
        maskPreviewEl.src = frameSrc;
        maskPreviewEl.style.display = 'block';
      } else {
        maskPreviewEl.style.display = 'none';
      }

      startCameraBtn.disabled = true;
      stopCameraBtn.disabled = false;
      takePhotoBtn.disabled = false;
    } catch (err) {
      console.error(err);
      alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –∫–∞–º–µ—Ä–∏.');
    }
  }

  function stopCamera() {
    if (cameraStream) {
      cameraStream.getTracks().forEach(t => t.stop());
      cameraStream = null;
    }
    videoEl.srcObject = null;
    videoEl.style.display = 'none';
    maskPreviewEl.style.display = 'none';

    startCameraBtn.disabled = false;
    stopCameraBtn.disabled = true;
    takePhotoBtn.disabled = true;
  }

  function takePhoto() {
    if (!cameraStream) return;

    const ctx = canvasEl.getContext('2d');
    const width  = canvasEl.width;
    const height = canvasEl.height;

    // –∫–∞–¥—Ä –∑ –∫–∞–º–µ—Ä–∏
    ctx.drawImage(videoEl, 0, 0, width, height);

    const frameSrc = FRAME_FILES[currentAnimalType];

    if (frameSrc) {
      const frame = new Image();
      frame.onload = () => {
        ctx.drawImage(frame, 0, 0, width, height);
        finishPhoto();
      };
      frame.onerror = finishPhoto;
      frame.src = frameSrc;
    } else {
      finishPhoto();
    }

    function finishPhoto() {
      canvasEl.style.display = 'block';
      const dataURL = canvasEl.toDataURL('image/png');
      downloadLinkEl.href = dataURL;
      downloadLinkEl.download = 'my_animal_photo.png';
      downloadLinkEl.style.display = 'inline-block';
    }
  }

  startCameraBtn.addEventListener('click', startCamera);
  stopCameraBtn.addEventListener('click', stopCamera);
  takePhotoBtn.addEventListener('click', takePhoto);
</script>
</body>
</html>

